/*! ngImgCrop v0.3.2 License: MIT */(function(){"use strict";var e=angular.module("ngImgCrop",[]);e.factory("cropAreaCircle",["cropArea",function(e){var t=function(){e.apply(this,arguments);this._boxResizeBaseSize=20;this._boxResizeNormalRatio=.9;this._boxResizeHoverRatio=1.2;this._iconMoveNormalRatio=.9;this._iconMoveHoverRatio=1.2;this._boxResizeNormalSize=this._boxResizeBaseSize*this._boxResizeNormalRatio;this._boxResizeHoverSize=this._boxResizeBaseSize*this._boxResizeHoverRatio;this._posDragStartX=0;this._posDragStartY=0;this._posResizeStartX=0;this._posResizeStartY=0;this._posResizeStartSize=0;this._boxResizeIsHover=false;this._areaIsHover=false;this._boxResizeIsDragging=false;this._areaIsDragging=false};t.prototype=new e;t.prototype._calcCirclePerimeterCoords=function(e){var t=this._size/2;var i=e*(Math.PI/180),r=this._x+t*Math.cos(i),s=this._y+t*Math.sin(i);return[r,s]};t.prototype._calcResizeIconCenterCoords=function(){return this._calcCirclePerimeterCoords(-45)};t.prototype._isCoordWithinArea=function(e){return Math.sqrt((e[0]-this._x)*(e[0]-this._x)+(e[1]-this._y)*(e[1]-this._y))<this._size/2};t.prototype._isCoordWithinBoxResize=function(e){var t=this._calcResizeIconCenterCoords();var i=this._boxResizeHoverSize/2;return e[0]>t[0]-i&&e[0]<t[0]+i&&e[1]>t[1]-i&&e[1]<t[1]+i};t.prototype._drawArea=function(e,t,i){e.arc(t[0],t[1],i/2,0,2*Math.PI)};t.prototype.draw=function(){e.prototype.draw.apply(this,arguments);this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);this._cropCanvas.drawIconResizeBoxNESW(this._calcResizeIconCenterCoords(),this._boxResizeBaseSize,this._boxResizeIsHover?this._boxResizeHoverRatio:this._boxResizeNormalRatio)};t.prototype.processMouseMove=function(e,t){var i="default";var r=false;this._boxResizeIsHover=false;this._areaIsHover=false;if(this._areaIsDragging){this._x=e-this._posDragStartX;this._y=t-this._posDragStartY;this._areaIsHover=true;i="move";r=true;this._events.trigger("area-move")}else if(this._boxResizeIsDragging){i="nesw-resize";var s,a,o;a=e-this._posResizeStartX;o=this._posResizeStartY-t;if(a>o){s=this._posResizeStartSize+o*2}else{s=this._posResizeStartSize+a*2}this._size=Math.max(this._minSize,s);this._boxResizeIsHover=true;r=true;this._events.trigger("area-resize")}else if(this._isCoordWithinBoxResize([e,t])){i="nesw-resize";this._areaIsHover=false;this._boxResizeIsHover=true;r=true}else if(this._isCoordWithinArea([e,t])){i="move";this._areaIsHover=true;r=true}this._dontDragOutside();angular.element(this._ctx.canvas).css({cursor:i});return r};t.prototype.processMouseDown=function(e,t){if(this._isCoordWithinBoxResize([e,t])){this._areaIsDragging=false;this._areaIsHover=false;this._boxResizeIsDragging=true;this._boxResizeIsHover=true;this._posResizeStartX=e;this._posResizeStartY=t;this._posResizeStartSize=this._size;this._events.trigger("area-resize-start")}else if(this._isCoordWithinArea([e,t])){this._areaIsDragging=true;this._areaIsHover=true;this._boxResizeIsDragging=false;this._boxResizeIsHover=false;this._posDragStartX=e-this._x;this._posDragStartY=t-this._y;this._events.trigger("area-move-start")}};t.prototype.processMouseUp=function(){if(this._areaIsDragging){this._areaIsDragging=false;this._events.trigger("area-move-end")}if(this._boxResizeIsDragging){this._boxResizeIsDragging=false;this._events.trigger("area-resize-end")}this._areaIsHover=false;this._boxResizeIsHover=false;this._posDragStartX=0;this._posDragStartY=0};return t}]);e.factory("cropAreaSquare",["cropArea",function(s){var e=function(){s.apply(this,arguments);this._resizeCtrlBaseRadius=10;this._resizeCtrlNormalRatio=.75;this._resizeCtrlHoverRatio=1;this._iconMoveNormalRatio=.9;this._iconMoveHoverRatio=1.2;this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio;this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio;this._posDragStartX=0;this._posDragStartY=0;this._posResizeStartX=0;this._posResizeStartY=0;this._posResizeStartSize=0;this._resizeCtrlIsHover=-1;this._areaIsHover=false;this._resizeCtrlIsDragging=-1;this._areaIsDragging=false};e.prototype=new s;e.prototype._calcSquareCorners=function(){var e=this._size/2;return[[this._x-e,this._y-e],[this._x+e,this._y-e],[this._x-e,this._y+e],[this._x+e,this._y+e]]};e.prototype._calcSquareDimensions=function(){var e=this._size/2;return{left:this._x-e,top:this._y-e,right:this._x+e,bottom:this._y+e}};e.prototype._isCoordWithinArea=function(e){var t=this._calcSquareDimensions();return e[0]>=t.left&&e[0]<=t.right&&e[1]>=t.top&&e[1]<=t.bottom};e.prototype._isCoordWithinResizeCtrl=function(e){var t=this._calcSquareCorners();var i=-1;for(var r=0,s=t.length;r<s;r++){var a=t[r];if(e[0]>a[0]-this._resizeCtrlHoverRadius&&e[0]<a[0]+this._resizeCtrlHoverRadius&&e[1]>a[1]-this._resizeCtrlHoverRadius&&e[1]<a[1]+this._resizeCtrlHoverRadius){i=r;break}}return i};e.prototype._drawArea=function(e,t,i){var r=i/2;e.rect(t[0]-r,t[1]-r,i,i)};e.prototype.draw=function(){s.prototype.draw.apply(this,arguments);this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);var e=this._calcSquareCorners();for(var t=0,i=e.length;t<i;t++){var r=e[t];this._cropCanvas.drawIconResizeCircle(r,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===t?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}};e.prototype.processMouseMove=function(e,t){var i="default";var r=false;this._resizeCtrlIsHover=-1;this._areaIsHover=false;if(this._areaIsDragging){this._x=e-this._posDragStartX;this._y=t-this._posDragStartY;this._areaIsHover=true;i="move";r=true;this._events.trigger("area-move")}else if(this._resizeCtrlIsDragging>-1){var s,a;switch(this._resizeCtrlIsDragging){case 0:s=-1;a=-1;i="nwse-resize";break;case 1:s=1;a=-1;i="nesw-resize";break;case 2:s=-1;a=1;i="nesw-resize";break;case 3:s=1;a=1;i="nwse-resize";break}var o=(e-this._posResizeStartX)*s;var n=(t-this._posResizeStartY)*a;var h;if(o>n){h=this._posResizeStartSize+n}else{h=this._posResizeStartSize+o}var l=this._size;this._size=Math.max(this._minSize,h);var c=(this._size-l)/2;this._x+=c*s;this._y+=c*a;this._resizeCtrlIsHover=this._resizeCtrlIsDragging;r=true;this._events.trigger("area-resize")}else{var u=this._isCoordWithinResizeCtrl([e,t]);if(u>-1){switch(u){case 0:i="nwse-resize";break;case 1:i="nesw-resize";break;case 2:i="nesw-resize";break;case 3:i="nwse-resize";break}this._areaIsHover=false;this._resizeCtrlIsHover=u;r=true}else if(this._isCoordWithinArea([e,t])){i="move";this._areaIsHover=true;r=true}}this._dontDragOutside();angular.element(this._ctx.canvas).css({cursor:i});return r};e.prototype.processMouseDown=function(e,t){var i=this._isCoordWithinResizeCtrl([e,t]);if(i>-1){this._areaIsDragging=false;this._areaIsHover=false;this._resizeCtrlIsDragging=i;this._resizeCtrlIsHover=i;this._posResizeStartX=e;this._posResizeStartY=t;this._posResizeStartSize=this._size;this._events.trigger("area-resize-start")}else if(this._isCoordWithinArea([e,t])){this._areaIsDragging=true;this._areaIsHover=true;this._resizeCtrlIsDragging=-1;this._resizeCtrlIsHover=-1;this._posDragStartX=e-this._x;this._posDragStartY=t-this._y;this._events.trigger("area-move-start")}};e.prototype.processMouseUp=function(){if(this._areaIsDragging){this._areaIsDragging=false;this._events.trigger("area-move-end")}if(this._resizeCtrlIsDragging>-1){this._resizeCtrlIsDragging=-1;this._events.trigger("area-resize-end")}this._areaIsHover=false;this._resizeCtrlIsHover=-1;this._posDragStartX=0;this._posDragStartY=0};return e}]);e.factory("cropArea",["cropCanvas",function(i){var e=function(e,t){this._ctx=e;this._events=t;this._minSize=80;this._cropCanvas=new i(e);this._image=new Image;this._x=0;this._y=0;this._size=200};e.prototype.getImage=function(){return this._image};e.prototype.setImage=function(e){this._image=e};e.prototype.getX=function(){return this._x};e.prototype.setX=function(e){this._x=e;this._dontDragOutside()};e.prototype.getY=function(){return this._y};e.prototype.setY=function(e){this._y=e;this._dontDragOutside()};e.prototype.getSize=function(){return this._size};e.prototype.setSize=function(e){this._size=Math.max(this._minSize,e);this._dontDragOutside()};e.prototype.getMinSize=function(){return this._minSize};e.prototype.setMinSize=function(e){this._minSize=e;this._size=Math.max(this._minSize,this._size);this._dontDragOutside()};e.prototype._dontDragOutside=function(){var e=this._ctx.canvas.height,t=this._ctx.canvas.width;if(this._size>t){this._size=t}if(this._size>e){this._size=e}if(this._x<this._size/2){this._x=this._size/2}if(this._x>t-this._size/2){this._x=t-this._size/2}if(this._y<this._size/2){this._y=this._size/2}if(this._y>e-this._size/2){this._y=e-this._size/2}};e.prototype._drawArea=function(){};e.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,[this._x,this._y],this._size,this._drawArea)};e.prototype.processMouseMove=function(){};e.prototype.processMouseDown=function(){};e.prototype.processMouseUp=function(){};return e}]);e.factory("cropCanvas",[function(){var s=[[-.5,-2],[-3,-4.5],[-.5,-7],[-7,-7],[-7,-.5],[-4.5,-3],[-2,-.5]];var a=[[.5,-2],[3,-4.5],[.5,-7],[7,-7],[7,-.5],[4.5,-3],[2,-.5]];var o=[[-.5,2],[-3,4.5],[-.5,7],[-7,7],[-7,.5],[-4.5,3],[-2,.5]];var l=[[.5,2],[3,4.5],[.5,7],[7,7],[7,.5],[4.5,3],[2,.5]];var i=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]];var c=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]];var u=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]];var g=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]];var f={areaOutline:"#fff",resizeBoxStroke:"#fff",resizeBoxFill:"#444",resizeBoxArrowFill:"#fff",resizeCircleStroke:"#fff",resizeCircleFill:"#444",moveIconFill:"#fff"};return function(h){var n=function(e,t,i){return[i*e[0]+t[0],i*e[1]+t[1]]};var r=function(e,t,i,r){h.save();h.fillStyle=t;h.beginPath();var s,a=n(e[0],i,r);h.moveTo(a[0],a[1]);for(var o in e){if(o>0){s=n(e[o],i,r);h.lineTo(s[0],s[1])}}h.lineTo(a[0],a[1]);h.fill();h.closePath();h.restore()};this.drawIconMove=function(e,t){r(i,f.moveIconFill,e,t);r(c,f.moveIconFill,e,t);r(u,f.moveIconFill,e,t);r(g,f.moveIconFill,e,t)};this.drawIconResizeCircle=function(e,t,i){var r=t*i;h.save();h.strokeStyle=f.resizeCircleStroke;h.lineWidth=2;h.fillStyle=f.resizeCircleFill;h.beginPath();h.arc(e[0],e[1],r,0,2*Math.PI);h.fill();h.stroke();h.closePath();h.restore()};this.drawIconResizeBoxBase=function(e,t,i){var r=t*i;h.save();h.strokeStyle=f.resizeBoxStroke;h.lineWidth=2;h.fillStyle=f.resizeBoxFill;h.fillRect(e[0]-r/2,e[1]-r/2,r,r);h.strokeRect(e[0]-r/2,e[1]-r/2,r,r);h.restore()};this.drawIconResizeBoxNESW=function(e,t,i){this.drawIconResizeBoxBase(e,t,i);r(a,f.resizeBoxArrowFill,e,i);r(o,f.resizeBoxArrowFill,e,i)};this.drawIconResizeBoxNWSE=function(e,t,i){this.drawIconResizeBoxBase(e,t,i);r(s,f.resizeBoxArrowFill,e,i);r(l,f.resizeBoxArrowFill,e,i)};this.drawCropArea=function(e,t,i,r){var s=e.width/h.canvas.width,a=e.height/h.canvas.height,o=t[0]-i/2,n=t[1]-i/2;h.save();h.strokeStyle=f.areaOutline;h.lineWidth=2;h.beginPath();r(h,t,i);h.stroke();h.clip();if(i>0){h.drawImage(e,o*s,n*a,i*s,i*a,o,n,i,i)}h.beginPath();r(h,t,i);h.stroke();h.clip();h.restore()}}}]);e.service("cropEXIF",[function(){var c=false;var l=this.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"};var u=this.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"};var g=this.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"};var f=this.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}};function e(e,t,i){if(e.addEventListener){e.addEventListener(t,i,false)}else if(e.attachEvent){e.attachEvent("on"+t,i)}}function s(e){return!!e.exifdata}function o(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"";e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");var i=atob(e);var r=i.length;var s=new ArrayBuffer(r);var a=new Uint8Array(s);for(var o=0;o<r;o++){a[o]=i.charCodeAt(o)}return s}function n(e,t){var i=new XMLHttpRequest;i.open("GET",e,true);i.responseType="blob";i.onload=function(e){if(this.status==200||this.status===0){t(this.response)}};i.send()}function i(r,s){function t(e){var t=h(e);var i=d(e);r.exifdata=t||{};r.iptcdata=i||{};if(s){s.call(r)}}if(r.src){if(/^data\:/i.test(r.src)){var e=o(r.src);t(e)}else if(/^blob\:/i.test(r.src)){var i=new FileReader;i.onload=function(e){t(e.target.result)};n(r.src,function(e){i.readAsArrayBuffer(e)})}else{var a=new XMLHttpRequest;a.onload=function(){if(this.status==200||this.status===0){t(a.response)}else{throw"Could not load image"}a=null};a.open("GET",r.src,true);a.responseType="arraybuffer";a.send(null)}}else if(window.FileReader&&(r instanceof window.Blob||r instanceof window.File)){var i=new FileReader;i.onload=function(e){if(c)console.log("Got file of length "+e.target.result.byteLength);t(e.target.result)};i.readAsArrayBuffer(r)}}function h(e){var t=new DataView(e);if(c)console.log("Got file of length "+e.byteLength);if(t.getUint8(0)!=255||t.getUint8(1)!=216){if(c)console.log("Not a valid JPEG");return false}var i=2,r=e.byteLength,s;while(i<r){if(t.getUint8(i)!=255){if(c)console.log("Not a valid marker at offset "+i+", found: "+t.getUint8(i));return false}s=t.getUint8(i+1);if(c)console.log(s);if(s==225){if(c)console.log("Found 0xFFE1 marker");return a(t,i+4,t.getUint16(i+2)-2)}else{i+=2+t.getUint16(i+2)}}}function d(e){var t=new DataView(e);if(c)console.log("Got file of length "+e.byteLength);if(t.getUint8(0)!=255||t.getUint8(1)!=216){if(c)console.log("Not a valid JPEG");return false}var i=2,r=e.byteLength;var s=function(e,t){return e.getUint8(t)===56&&e.getUint8(t+1)===66&&e.getUint8(t+2)===73&&e.getUint8(t+3)===77&&e.getUint8(t+4)===4&&e.getUint8(t+5)===4};while(i<r){if(s(t,i)){var a=t.getUint8(i+7);if(a%2!==0)a+=1;if(a===0){a=4}var o=i+8+a;var n=t.getUint16(i+6+a);return v(e,o,n);break}i++}}var p={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};function v(e,t,i){var r=new DataView(e);var s={};var a,o,n,h,l;var c=t;while(c<t+i){if(r.getUint8(c)===28&&r.getUint8(c+1)===2){h=r.getUint8(c+2);if(h in p){n=r.getInt16(c+3);l=n+5;o=p[h];a=S(r,c+5,n);if(s.hasOwnProperty(o)){if(s[o]instanceof Array){s[o].push(a)}else{s[o]=[s[o],a]}}else{s[o]=a}}}c++}return s}function _(e,t,i,r,s){var a=e.getUint16(i,!s),o={},n,h,l;for(l=0;l<a;l++){n=i+l*12+2;h=r[e.getUint16(n,!s)];if(!h&&c)console.log("Unknown tag: "+e.getUint16(n,!s));o[h]=m(e,n,t,i,s)}return o}function m(e,t,i,r,s){var a=e.getUint16(t+2,!s),o=e.getUint32(t+4,!s),n=e.getUint32(t+8,!s)+i,h,l,c,u,g,f;switch(a){case 1:case 7:if(o==1){return e.getUint8(t+8,!s)}else{h=o>4?n:t+8;l=[];for(u=0;u<o;u++){l[u]=e.getUint8(h+u)}return l}case 2:h=o>4?n:t+8;return S(e,h,o-1);case 3:if(o==1){return e.getUint16(t+8,!s)}else{h=o>2?n:t+8;l=[];for(u=0;u<o;u++){l[u]=e.getUint16(h+2*u,!s)}return l}case 4:if(o==1){return e.getUint32(t+8,!s)}else{l=[];for(u=0;u<o;u++){l[u]=e.getUint32(n+4*u,!s)}return l}case 5:if(o==1){g=e.getUint32(n,!s);f=e.getUint32(n+4,!s);c=new Number(g/f);c.numerator=g;c.denominator=f;return c}else{l=[];for(u=0;u<o;u++){g=e.getUint32(n+8*u,!s);f=e.getUint32(n+4+8*u,!s);l[u]=new Number(g/f);l[u].numerator=g;l[u].denominator=f}return l}case 9:if(o==1){return e.getInt32(t+8,!s)}else{l=[];for(u=0;u<o;u++){l[u]=e.getInt32(n+4*u,!s)}return l}case 10:if(o==1){return e.getInt32(n,!s)/e.getInt32(n+4,!s)}else{l=[];for(u=0;u<o;u++){l[u]=e.getInt32(n+8*u,!s)/e.getInt32(n+4+8*u,!s)}return l}}}function S(e,t,i){var r="";for(var s=t;s<t+i;s++){r+=String.fromCharCode(e.getUint8(s))}return r}function a(e,t){if(S(e,t,4)!="Exif"){if(c)console.log("Not valid EXIF data! "+S(e,t,4));return false}var i,r,s,a,o,n=t+6;if(e.getUint16(n)==18761){i=false}else if(e.getUint16(n)==19789){i=true}else{if(c)console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)");return false}if(e.getUint16(n+2,!i)!=42){if(c)console.log("Not valid TIFF data! (no 0x002A)");return false}var h=e.getUint32(n+4,!i);if(h<8){if(c)console.log("Not valid TIFF data! (First offset less than 8)",e.getUint32(n+4,!i));return false}r=_(e,n,n+h,u,i);if(r.ExifIFDPointer){a=_(e,n,n+r.ExifIFDPointer,l,i);for(s in a){switch(s){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":a[s]=f[s][a[s]];break;case"ExifVersion":case"FlashpixVersion":a[s]=String.fromCharCode(a[s][0],a[s][1],a[s][2],a[s][3]);break;case"ComponentsConfiguration":a[s]=f.Components[a[s][0]]+f.Components[a[s][1]]+f.Components[a[s][2]]+f.Components[a[s][3]];break}r[s]=a[s]}}if(r.GPSInfoIFDPointer){o=_(e,n,n+r.GPSInfoIFDPointer,g,i);for(s in o){switch(s){case"GPSVersionID":o[s]=o[s][0]+"."+o[s][1]+"."+o[s][2]+"."+o[s][3];break}r[s]=o[s]}}return r}this.getData=function(e,t){if((e instanceof Image||e instanceof HTMLImageElement)&&!e.complete)return false;if(!s(e)){i(e,t)}else{if(t){t.call(e)}}return true};this.getTag=function(e,t){if(!s(e))return;return e.exifdata[t]};this.getAllTags=function(e){if(!s(e))return{};var t,i=e.exifdata,r={};for(t in i){if(i.hasOwnProperty(t)){r[t]=i[t]}}return r};this.pretty=function(e){if(!s(e))return"";var t,i=e.exifdata,r="";for(t in i){if(i.hasOwnProperty(t)){if(typeof i[t]=="object"){if(i[t]instanceof Number){r+=t+" : "+i[t]+" ["+i[t].numerator+"/"+i[t].denominator+"]\r\n"}else{r+=t+" : ["+i[t].length+" values]\r\n"}}else{r+=t+" : "+i[t]+"\r\n"}}}return r};this.readFromBinaryFile=function(e){return h(e)}}]);e.factory("cropHost",["$document","cropAreaCircle","cropAreaSquare","cropEXIF",function(h,l,S,z){var I=function(e){var t=e.getBoundingClientRect();var i=document.body;var r=document.documentElement;var s=window.pageYOffset||r.scrollTop||i.scrollTop;var a=window.pageXOffset||r.scrollLeft||i.scrollLeft;var o=r.clientTop||i.clientTop||0;var n=r.clientLeft||i.clientLeft||0;var h=t.top+s-o;var l=t.left+a-n;return{top:Math.round(h),left:Math.round(l)}};return function(c,e,u){var g=null,f=null,d=null;var p=[100,100],v=[300,300];var i=200;var r="image/png";var s=null;function _(){g.clearRect(0,0,g.canvas.width,g.canvas.height);if(f!==null){g.drawImage(f,0,0,g.canvas.width,g.canvas.height);g.save();g.fillStyle="rgba(0, 0, 0, 0.65)";g.fillRect(0,0,g.canvas.width,g.canvas.height);g.restore();d.draw()}}var m=function(){if(f!==null){d.setImage(f);var e=[f.width,f.height],t=f.width/f.height,i=e;if(i[0]>v[0]){i[0]=v[0];i[1]=i[0]/t}else if(i[0]<p[0]){i[0]=p[0];i[1]=i[0]/t}if(i[1]>v[1]){i[1]=v[1];i[0]=i[1]*t}else if(i[1]<p[1]){i[1]=p[1];i[0]=i[1]*t}c.prop("width",i[0]).prop("height",i[1]).css({"margin-left":-i[0]/2+"px","margin-top":-i[1]/2+"px"});d.setX(g.canvas.width/2);d.setY(g.canvas.height/2);d.setSize(Math.min(200,g.canvas.width/2,g.canvas.height/2))}else{c.prop("width",0).prop("height",0).css({"margin-top":0})}_()};var a=function(e){if(angular.isDefined(e.changedTouches)){return e.changedTouches}else{return e.originalEvent.changedTouches}};var t=function(e){if(f!==null){var t=I(g.canvas),i,r;if(e.type==="touchmove"){i=a(e)[0].pageX;r=a(e)[0].pageY}else{i=e.pageX;r=e.pageY}d.processMouseMove(i-t.left,r-t.top);_()}};var o=function(e){e.preventDefault();e.stopPropagation();if(f!==null){var t=I(g.canvas),i,r;if(e.type==="touchstart"){i=a(e)[0].pageX;r=a(e)[0].pageY}else{i=e.pageX;r=e.pageY}d.processMouseDown(i-t.left,r-t.top);_()}};var n=function(e){if(f!==null){var t=I(g.canvas),i,r;if(e.type==="touchend"){i=a(e)[0].pageX;r=a(e)[0].pageY}else{i=e.pageX;r=e.pageY}d.processMouseUp(i-t.left,r-t.top);_()}};this.getResultImageDataURI=function(){var e,t;t=angular.element("<canvas></canvas>")[0];e=t.getContext("2d");t.width=i;t.height=i;if(f!==null){e.drawImage(f,(d.getX()-d.getSize()/2)*(f.width/g.canvas.width),(d.getY()-d.getSize()/2)*(f.height/g.canvas.height),d.getSize()*(f.width/g.canvas.width),d.getSize()*(f.height/g.canvas.height),0,0,i,i)}if(s!==null){return t.toDataURL(r,s)}return t.toDataURL(r)};this.setNewImageSource=function(e){f=null;m();u.trigger("image-updated");if(!!e){var l=new Image;if(e.substring(0,4).toLowerCase()==="http"){l.crossOrigin="anonymous"}l.onload=function(){u.trigger("load-done");z.getData(l,function(){var e=z.getTag(l,"Orientation");if([3,6,8].indexOf(e)>-1){var t=document.createElement("canvas"),i=t.getContext("2d"),r=l.width,s=l.height,a=0,o=0,n=0;switch(e){case 3:a=-l.width;o=-l.height;n=180;break;case 6:r=l.height;s=l.width;o=-l.height;n=90;break;case 8:r=l.height;s=l.width;a=-l.width;n=270;break}t.width=r;t.height=s;i.rotate(n*Math.PI/180);i.drawImage(l,a,o);var h=new Image;h.src=t.toDataURL("image/png");h.onload=function(){f=h;setTimeout(function(){m();u.trigger("image-updated")},20)}}else{f=l}m();u.trigger("image-updated")})};l.onerror=function(){u.trigger("load-error")};u.trigger("load-start");l.src=e}};this.setMaxDimensions=function(e,t){v=[e,t];if(f!==null){var i=g.canvas.width,r=g.canvas.height;var s=[f.width,f.height],a=f.width/f.height,o=s;if(o[0]>v[0]){o[0]=v[0];o[1]=o[0]/a}else if(o[0]<p[0]){o[0]=p[0];o[1]=o[0]/a}if(o[1]>v[1]){o[1]=v[1];o[0]=o[1]*a}else if(o[1]<p[1]){o[1]=p[1];o[0]=o[1]*a}c.prop("width",o[0]).prop("height",o[1]).css({"margin-left":-o[0]/2+"px","margin-top":-o[1]/2+"px"});var n=g.canvas.width/i,h=g.canvas.height/r,l=Math.min(n,h);d.setX(d.getX()*n);d.setY(d.getY()*h);d.setSize(d.getSize()*l)}else{c.prop("width",0).prop("height",0).css({"margin-top":0})}_()};this.setAreaMinSize=function(e){e=parseInt(e,10);if(!isNaN(e)){d.setMinSize(e);_()}};this.setResultImageSize=function(e){e=parseInt(e,10);if(!isNaN(e)){i=e}};this.setResultImageFormat=function(e){r=e};this.setResultImageQuality=function(e){e=parseFloat(e);if(!isNaN(e)&&e>=0&&e<=1){s=e}};this.setAreaType=function(e){var t=d.getSize(),i=d.getMinSize(),r=d.getX(),s=d.getY();var a=l;if(e==="square"){a=S}d=new a(g,u);d.setMinSize(i);d.setSize(t);d.setX(r);d.setY(s);if(f!==null){d.setImage(f)}_()};g=c[0].getContext("2d");d=new l(g,u);h.on("mousemove",t);c.on("mousedown",o);h.on("mouseup",n);h.on("touchmove",t);c.on("touchstart",o);h.on("touchend",n);this.destroy=function(){h.off("mousemove",t);c.off("mousedown",o);h.off("mouseup",t);h.off("touchmove",t);c.off("touchstart",o);h.off("touchend",t);c.remove()}}}]);e.factory("cropPubSub",[function(){return function(){var i={};this.on=function(e,t){e.split(" ").forEach(function(e){if(!i[e]){i[e]=[]}i[e].push(t)});return this};this.trigger=function(e,t){angular.forEach(i[e],function(e){e.call(null,t)});return this}}}]);e.directive("imgCrop",["$timeout","cropHost","cropPubSub",function(n,h,t){return{restrict:"E",scope:{image:"=",resultImage:"=",changeOnFly:"=",areaType:"@",areaMinSize:"=",resultImageSize:"=",resultImageFormat:"@",resultImageQuality:"=",onChange:"&",onLoadBegin:"&",onLoadDone:"&",onLoadError:"&"},template:"<canvas></canvas>",controller:["$scope",function(e){e.events=new t}],link:function(i,e){var t=i.events;var r=new h(e.find("canvas"),{},t);var s;var a=function(e){var t=r.getResultImageDataURI();if(s!==t){s=t;if(angular.isDefined(e.resultImage)){e.resultImage=t}e.onChange({$dataURI:e.resultImage})}};var o=function(t){return function(){n(function(){i.$apply(function(e){t(e)})})}};t.on("load-start",o(function(e){e.onLoadBegin({})})).on("load-done",o(function(e){e.onLoadDone({})})).on("load-error",o(function(e){e.onLoadError({})})).on("area-move area-resize",o(function(e){if(!!e.changeOnFly){a(e)}})).on("area-move-end area-resize-end image-updated",o(function(e){a(e)}));i.$watch("image",function(){r.setNewImageSource(i.image)});i.$watch("areaType",function(){r.setAreaType(i.areaType);a(i)});i.$watch("areaMinSize",function(){r.setAreaMinSize(i.areaMinSize);a(i)});i.$watch("resultImageSize",function(){r.setResultImageSize(i.resultImageSize);a(i)});i.$watch("resultImageFormat",function(){r.setResultImageFormat(i.resultImageFormat);a(i)});i.$watch("resultImageQuality",function(){r.setResultImageQuality(i.resultImageQuality);a(i)});i.$watch(function(){return[e[0].clientWidth,e[0].clientHeight]},function(e){r.setMaxDimensions(e[0],e[1]);a(i)},true);i.$on("$destroy",function(){r.destroy()})}}}])})();