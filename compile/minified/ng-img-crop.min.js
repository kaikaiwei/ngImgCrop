!function(){"use strict";var e=angular.module("ngImgCrop",[]);e.factory("cropAreaCircle",["cropArea",function(e){function t(){e.apply(this,arguments),this._boxResizeBaseSize=20,this._boxResizeNormalRatio=.9,this._boxResizeHoverRatio=1.2,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._boxResizeNormalSize=this._boxResizeBaseSize*this._boxResizeNormalRatio,this._boxResizeHoverSize=this._boxResizeBaseSize*this._boxResizeHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize=0,this._boxResizeIsHover=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!1,this._areaIsDragging=!1}return(t.prototype=new e)._calcCirclePerimeterCoords=function(e){var t=this._size/2,i=e*(Math.PI/180);return[this._x+t*Math.cos(i),this._y+t*Math.sin(i)]},t.prototype._calcResizeIconCenterCoords=function(){return this._calcCirclePerimeterCoords(-45)},t.prototype._isCoordWithinArea=function(e){return Math.sqrt((e[0]-this._x)*(e[0]-this._x)+(e[1]-this._y)*(e[1]-this._y))<this._size/2},t.prototype._isCoordWithinBoxResize=function(e){var t=this._calcResizeIconCenterCoords(),i=this._boxResizeHoverSize/2;return e[0]>t[0]-i&&e[0]<t[0]+i&&e[1]>t[1]-i&&e[1]<t[1]+i},t.prototype._drawArea=function(e,t,i){e.arc(t[0],t[1],i/2,0,2*Math.PI)},t.prototype.draw=function(){e.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio),this._cropCanvas.drawIconResizeBoxNESW(this._calcResizeIconCenterCoords(),this._boxResizeBaseSize,this._boxResizeIsHover?this._boxResizeHoverRatio:this._boxResizeNormalRatio)},t.prototype.processMouseMove=function(e,t){var i,r,s,o="default",a=!1;return this._boxResizeIsHover=!1,this._areaIsHover=!1,this._areaIsDragging?(this._x=e-this._posDragStartX,this._y=t-this._posDragStartY,o="move",a=this._areaIsHover=!0,this._events.trigger("area-move")):this._boxResizeIsDragging?(o="nesw-resize",i=e-this._posResizeStartX,s=(r=this._posResizeStartY-t)<i?this._posResizeStartSize+2*r:this._posResizeStartSize+2*i,this._size=Math.max(this._minSize,s),a=this._boxResizeIsHover=!0,this._events.trigger("area-resize")):this._isCoordWithinBoxResize([e,t])?(o="nesw-resize",this._areaIsHover=!1,a=this._boxResizeIsHover=!0):this._isCoordWithinArea([e,t])&&(o="move",a=this._areaIsHover=!0),this._dontDragOutside(),angular.element(this._ctx.canvas).css({cursor:o}),a},t.prototype.processMouseDown=function(e,t){this._isCoordWithinBoxResize([e,t])?(this._areaIsDragging=!1,this._areaIsHover=!1,this._boxResizeIsDragging=!0,this._boxResizeIsHover=!0,this._posResizeStartX=e,this._posResizeStartY=t,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start")):this._isCoordWithinArea([e,t])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._boxResizeIsDragging=!1,this._boxResizeIsHover=!1,this._posDragStartX=e-this._x,this._posDragStartY=t-this._y,this._events.trigger("area-move-start"))},t.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),this._boxResizeIsDragging&&(this._boxResizeIsDragging=!1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._boxResizeIsHover=!1,this._posDragStartX=0,this._posDragStartY=0},t}]),e.factory("cropAreaSquare",["cropArea",function(s){function e(){s.apply(this,arguments),this._resizeCtrlBaseRadius=10,this._resizeCtrlNormalRatio=.75,this._resizeCtrlHoverRatio=1,this._iconMoveNormalRatio=.9,this._iconMoveHoverRatio=1.2,this._resizeCtrlNormalRadius=this._resizeCtrlBaseRadius*this._resizeCtrlNormalRatio,this._resizeCtrlHoverRadius=this._resizeCtrlBaseRadius*this._resizeCtrlHoverRatio,this._posDragStartX=0,this._posDragStartY=0,this._posResizeStartX=0,this._posResizeStartY=0,this._posResizeStartSize=0,this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._resizeCtrlIsDragging=-1,this._areaIsDragging=!1}return(e.prototype=new s)._calcSquareCorners=function(){var e=this._size/2;return[[this._x-e,this._y-e],[this._x+e,this._y-e],[this._x-e,this._y+e],[this._x+e,this._y+e]]},e.prototype._calcSquareDimensions=function(){var e=this._size/2;return{left:this._x-e,top:this._y-e,right:this._x+e,bottom:this._y+e}},e.prototype._isCoordWithinArea=function(e){var t=this._calcSquareDimensions();return e[0]>=t.left&&e[0]<=t.right&&e[1]>=t.top&&e[1]<=t.bottom},e.prototype._isCoordWithinResizeCtrl=function(e){for(var t=this._calcSquareCorners(),i=-1,r=0,s=t.length;r<s;r++){var o=t[r];if(e[0]>o[0]-this._resizeCtrlHoverRadius&&e[0]<o[0]+this._resizeCtrlHoverRadius&&e[1]>o[1]-this._resizeCtrlHoverRadius&&e[1]<o[1]+this._resizeCtrlHoverRadius){i=r;break}}return i},e.prototype._drawArea=function(e,t,i){var r=i/2;e.rect(t[0]-r,t[1]-r,i,i)},e.prototype.draw=function(){s.prototype.draw.apply(this,arguments),this._cropCanvas.drawIconMove([this._x,this._y],this._areaIsHover?this._iconMoveHoverRatio:this._iconMoveNormalRatio);for(var e=this._calcSquareCorners(),t=0,i=e.length;t<i;t++){var r=e[t];this._cropCanvas.drawIconResizeCircle(r,this._resizeCtrlBaseRadius,this._resizeCtrlIsHover===t?this._resizeCtrlHoverRatio:this._resizeCtrlNormalRatio)}},e.prototype.processMouseMove=function(e,t){var i,r,s="default",o=!1;if(this._resizeCtrlIsHover=-1,this._areaIsHover=!1,this._areaIsDragging)this._x=e-this._posDragStartX,this._y=t-this._posDragStartY,s="move",o=this._areaIsHover=!0,this._events.trigger("area-move");else if(-1<this._resizeCtrlIsDragging){switch(this._resizeCtrlIsDragging){case 0:r=i=-1,s="nwse-resize";break;case 1:r=-(i=1),s="nesw-resize";break;case 2:i=-1,r=1,s="nesw-resize";break;case 3:r=i=1,s="nwse-resize"}var a=(e-this._posResizeStartX)*i,n=(t-this._posResizeStartY)*r,h=n<a?this._posResizeStartSize+n:this._posResizeStartSize+a,c=this._size;this._size=Math.max(this._minSize,h);var g=(this._size-c)/2;this._x+=g*i,this._y+=g*r,this._resizeCtrlIsHover=this._resizeCtrlIsDragging,o=!0,this._events.trigger("area-resize")}else{var u=this._isCoordWithinResizeCtrl([e,t]);if(-1<u){switch(u){case 0:s="nwse-resize";break;case 1:case 2:s="nesw-resize";break;case 3:s="nwse-resize"}this._areaIsHover=!1,this._resizeCtrlIsHover=u,o=!0}else this._isCoordWithinArea([e,t])&&(s="move",o=this._areaIsHover=!0)}return this._dontDragOutside(),angular.element(this._ctx.canvas).css({cursor:s}),o},e.prototype.processMouseDown=function(e,t){var i=this._isCoordWithinResizeCtrl([e,t]);-1<i?(this._areaIsDragging=!1,this._areaIsHover=!1,this._resizeCtrlIsDragging=i,this._resizeCtrlIsHover=i,this._posResizeStartX=e,this._posResizeStartY=t,this._posResizeStartSize=this._size,this._events.trigger("area-resize-start")):this._isCoordWithinArea([e,t])&&(this._areaIsDragging=!0,this._areaIsHover=!0,this._resizeCtrlIsDragging=-1,this._resizeCtrlIsHover=-1,this._posDragStartX=e-this._x,this._posDragStartY=t-this._y,this._events.trigger("area-move-start"))},e.prototype.processMouseUp=function(){this._areaIsDragging&&(this._areaIsDragging=!1,this._events.trigger("area-move-end")),-1<this._resizeCtrlIsDragging&&(this._resizeCtrlIsDragging=-1,this._events.trigger("area-resize-end")),this._areaIsHover=!1,this._resizeCtrlIsHover=-1,this._posDragStartX=0,this._posDragStartY=0},e}]),e.factory("cropArea",["cropCanvas",function(i){function e(e,t){this._ctx=e,this._events=t,this._minSize=80,this._cropCanvas=new i(e),this._image=new Image,this._x=0,this._y=0,this._size=200}return e.prototype.getImage=function(){return this._image},e.prototype.setImage=function(e){this._image=e},e.prototype.getX=function(){return this._x},e.prototype.setX=function(e){this._x=e,this._dontDragOutside()},e.prototype.getY=function(){return this._y},e.prototype.setY=function(e){this._y=e,this._dontDragOutside()},e.prototype.getSize=function(){return this._size},e.prototype.setSize=function(e){this._size=Math.max(this._minSize,e),this._dontDragOutside()},e.prototype.getMinSize=function(){return this._minSize},e.prototype.setMinSize=function(e){this._minSize=e,this._size=Math.max(this._minSize,this._size),this._dontDragOutside()},e.prototype._dontDragOutside=function(){var e=this._ctx.canvas.height,t=this._ctx.canvas.width;this._size>t&&(this._size=t),this._size>e&&(this._size=e),this._x<this._size/2&&(this._x=this._size/2),this._x>t-this._size/2&&(this._x=t-this._size/2),this._y<this._size/2&&(this._y=this._size/2),this._y>e-this._size/2&&(this._y=e-this._size/2)},e.prototype._drawArea=function(){},e.prototype.draw=function(){this._cropCanvas.drawCropArea(this._image,[this._x,this._y],this._size,this._drawArea)},e.prototype.processMouseMove=function(){},e.prototype.processMouseDown=function(){},e.prototype.processMouseUp=function(){},e}]),e.factory("cropCanvas",[function(){var s=[[-.5,-2],[-3,-4.5],[-.5,-7],[-7,-7],[-7,-.5],[-4.5,-3],[-2,-.5]],o=[[.5,-2],[3,-4.5],[.5,-7],[7,-7],[7,-.5],[4.5,-3],[2,-.5]],a=[[-.5,2],[-3,4.5],[-.5,7],[-7,7],[-7,.5],[-4.5,3],[-2,.5]],c=[[.5,2],[3,4.5],[.5,7],[7,7],[7,.5],[4.5,3],[2,.5]],i=[[-1.5,-2.5],[-1.5,-6],[-5,-6],[0,-11],[5,-6],[1.5,-6],[1.5,-2.5]],g=[[-2.5,-1.5],[-6,-1.5],[-6,-5],[-11,0],[-6,5],[-6,1.5],[-2.5,1.5]],u=[[-1.5,2.5],[-1.5,6],[-5,6],[0,11],[5,6],[1.5,6],[1.5,2.5]],l=[[2.5,-1.5],[6,-1.5],[6,-5],[11,0],[6,5],[6,1.5],[2.5,1.5]],d="#fff",p="#fff",f="#444",_="#fff",m="#fff",v="#444",S="#fff";return function(h){function n(e,t,i){return[i*e[0]+t[0],i*e[1]+t[1]]}function r(e,t,i,r){h.save(),h.fillStyle=t,h.beginPath();var s,o=n(e[0],i,r);for(var a in h.moveTo(o[0],o[1]),e)0<a&&(s=n(e[a],i,r),h.lineTo(s[0],s[1]));h.lineTo(o[0],o[1]),h.fill(),h.closePath(),h.restore()}this.drawIconMove=function(e,t){r(i,S,e,t),r(g,S,e,t),r(u,S,e,t),r(l,S,e,t)},this.drawIconResizeCircle=function(e,t,i){var r=t*i;h.save(),h.strokeStyle=m,h.lineWidth=2,h.fillStyle=v,h.beginPath(),h.arc(e[0],e[1],r,0,2*Math.PI),h.fill(),h.stroke(),h.closePath(),h.restore()},this.drawIconResizeBoxBase=function(e,t,i){var r=t*i;h.save(),h.strokeStyle=p,h.lineWidth=2,h.fillStyle=f,h.fillRect(e[0]-r/2,e[1]-r/2,r,r),h.strokeRect(e[0]-r/2,e[1]-r/2,r,r),h.restore()},this.drawIconResizeBoxNESW=function(e,t,i){this.drawIconResizeBoxBase(e,t,i),r(o,_,e,i),r(a,_,e,i)},this.drawIconResizeBoxNWSE=function(e,t,i){this.drawIconResizeBoxBase(e,t,i),r(s,_,e,i),r(c,_,e,i)},this.drawCropArea=function(e,t,i,r){var s=e.width/h.canvas.width,o=e.height/h.canvas.height,a=t[0]-i/2,n=t[1]-i/2;h.save(),h.strokeStyle=d,h.lineWidth=2,h.beginPath(),r(h,t,i),h.stroke(),h.clip(),0<i&&h.drawImage(e,a*s,n*o,i*s,i*o,a,n,i,i),h.beginPath(),r(h,t,i),h.stroke(),h.clip(),h.restore()}}}]),e.service("cropEXIF",[function(){var g=!1,c=this.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},u=this.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},l=this.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},d=this.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}};function s(e){return e.exifdata}function i(r,s){function t(e){var t=h(e),i=function(e){var t=new DataView(e);g&&console.log("Got file of length "+e.byteLength);if(255!=t.getUint8(0)||216!=t.getUint8(1))return g&&console.log("Not a valid JPEG"),!1;var i=2,r=e.byteLength;for(;i<r;){if(function(e,t){return 56===e.getUint8(t)&&66===e.getUint8(t+1)&&73===e.getUint8(t+2)&&77===e.getUint8(t+3)&&4===e.getUint8(t+4)&&4===e.getUint8(t+5)}(t,i)){var s=t.getUint8(i+7);s%2!=0&&(s+=1),0===s&&(s=4);var o=i+8+s,a=t.getUint16(i+6+s);return function(e,t,i){var r,s,o,a,n=new DataView(e),h={},c=t;for(;c<t+i;)28===n.getUint8(c)&&2===n.getUint8(c+1)&&(a=n.getUint8(c+2))in p&&(o=n.getInt16(c+3),s=p[a],r=_(n,c+5,o),h.hasOwnProperty(s)?h[s]instanceof Array?h[s].push(r):h[s]=[h[s],r]:h[s]=r),c++;return h}(e,o,a)}i++}}(e);r.exifdata=t||{},r.iptcdata=i||{},s&&s.call(r)}var e,i,o,a,n;r.src?/^data\:/i.test(r.src)?t(function(e,t){t=t||e.match(/^data\:([^\;]+)\;base64,/im)[1]||"",e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var i=atob(e),r=i.length,s=new ArrayBuffer(r),o=new Uint8Array(s),a=0;a<r;a++)o[a]=i.charCodeAt(a);return s}(r.src)):/^blob\:/i.test(r.src)?((i=new FileReader).onload=function(e){t(e.target.result)},o=r.src,a=function(e){i.readAsArrayBuffer(e)},(n=new XMLHttpRequest).open("GET",o,!0),n.responseType="blob",n.onload=function(e){200!=this.status&&0!==this.status||a(this.response)},n.send()):((e=new XMLHttpRequest).onload=function(){if(200!=this.status&&0!==this.status)throw"Could not load image";t(e.response),e=null},e.open("GET",r.src,!0),e.responseType="arraybuffer",e.send(null)):window.FileReader&&(r instanceof window.Blob||r instanceof window.File)&&((i=new FileReader).onload=function(e){g&&console.log("Got file of length "+e.target.result.byteLength),t(e.target.result)},i.readAsArrayBuffer(r))}function h(e){var t=new DataView(e);if(g&&console.log("Got file of length "+e.byteLength),255!=t.getUint8(0)||216!=t.getUint8(1))return g&&console.log("Not a valid JPEG"),!1;for(var i,r=2,s=e.byteLength;r<s;){if(255!=t.getUint8(r))return g&&console.log("Not a valid marker at offset "+r+", found: "+t.getUint8(r)),!1;if(i=t.getUint8(r+1),g&&console.log(i),225==i)return g&&console.log("Found 0xFFE1 marker"),function(e,t){if("Exif"!=_(e,t,4))return g&&console.log("Not valid EXIF data! "+_(e,t,4)),!1;var i,r,s,o,a,n=t+6;if(18761==e.getUint16(n))i=!1;else{if(19789!=e.getUint16(n))return g&&console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;i=!0}if(42!=e.getUint16(n+2,!i))return g&&console.log("Not valid TIFF data! (no 0x002A)"),!1;var h=e.getUint32(n+4,!i);if(h<8)return g&&console.log("Not valid TIFF data! (First offset less than 8)",e.getUint32(n+4,!i)),!1;if((r=f(e,n,n+h,u,i)).ExifIFDPointer)for(s in o=f(e,n,n+r.ExifIFDPointer,c,i)){switch(s){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":o[s]=d[s][o[s]];break;case"ExifVersion":case"FlashpixVersion":o[s]=String.fromCharCode(o[s][0],o[s][1],o[s][2],o[s][3]);break;case"ComponentsConfiguration":o[s]=d.Components[o[s][0]]+d.Components[o[s][1]]+d.Components[o[s][2]]+d.Components[o[s][3]]}r[s]=o[s]}if(r.GPSInfoIFDPointer)for(s in a=f(e,n,n+r.GPSInfoIFDPointer,l,i)){switch(s){case"GPSVersionID":a[s]=a[s][0]+"."+a[s][1]+"."+a[s][2]+"."+a[s][3]}r[s]=a[s]}return r}(t,r+4,t.getUint16(r+2));r+=2+t.getUint16(r+2)}}var p={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"};function f(e,t,i,r,s){for(var o,a,n=e.getUint16(i,!s),h={},c=0;c<n;c++)o=i+12*c+2,!(a=r[e.getUint16(o,!s)])&&g&&console.log("Unknown tag: "+e.getUint16(o,!s)),h[a]=function(e,t,i,r){var s,o,a,n,h,c,g=e.getUint16(t+2,!r),u=e.getUint32(t+4,!r),l=e.getUint32(t+8,!r)+i;switch(g){case 1:case 7:if(1==u)return e.getUint8(t+8,!r);for(s=4<u?l:t+8,o=[],n=0;n<u;n++)o[n]=e.getUint8(s+n);return o;case 2:return _(e,s=4<u?l:t+8,u-1);case 3:if(1==u)return e.getUint16(t+8,!r);for(s=2<u?l:t+8,o=[],n=0;n<u;n++)o[n]=e.getUint16(s+2*n,!r);return o;case 4:if(1==u)return e.getUint32(t+8,!r);for(o=[],n=0;n<u;n++)o[n]=e.getUint32(l+4*n,!r);return o;case 5:if(1==u)return h=e.getUint32(l,!r),c=e.getUint32(l+4,!r),(a=new Number(h/c)).numerator=h,a.denominator=c,a;for(o=[],n=0;n<u;n++)h=e.getUint32(l+8*n,!r),c=e.getUint32(l+4+8*n,!r),o[n]=new Number(h/c),o[n].numerator=h,o[n].denominator=c;return o;case 9:if(1==u)return e.getInt32(t+8,!r);for(o=[],n=0;n<u;n++)o[n]=e.getInt32(l+4*n,!r);return o;case 10:if(1==u)return e.getInt32(l,!r)/e.getInt32(l+4,!r);for(o=[],n=0;n<u;n++)o[n]=e.getInt32(l+8*n,!r)/e.getInt32(l+4+8*n,!r);return o}}(e,o,t,s);return h}function _(e,t,i){for(var r="",s=t;s<t+i;s++)r+=String.fromCharCode(e.getUint8(s));return r}this.getData=function(e,t){return!((e instanceof Image||e instanceof HTMLImageElement)&&!e.complete)&&(s(e)?t&&t.call(e):i(e,t),!0)},this.getTag=function(e,t){if(s(e))return e.exifdata[t]},this.getAllTags=function(e){if(!s(e))return{};var t,i=e.exifdata,r={};for(t in i)i.hasOwnProperty(t)&&(r[t]=i[t]);return r},this.pretty=function(e){if(!s(e))return"";var t,i=e.exifdata,r="";for(t in i)i.hasOwnProperty(t)&&("object"==typeof i[t]?i[t]instanceof Number?r+=t+" : "+i[t]+" ["+i[t].numerator+"/"+i[t].denominator+"]\r\n":r+=t+" : ["+i[t].length+" values]\r\n":r+=t+" : "+i[t]+"\r\n");return r},this.readFromBinaryFile=h}]),e.factory("cropHost",["$document","cropAreaCircle","cropAreaSquare","cropEXIF",function(h,c,S,z){function I(e){var t=e.getBoundingClientRect(),i=document.body,r=document.documentElement,s=window.pageYOffset||r.scrollTop||i.scrollTop,o=window.pageXOffset||r.scrollLeft||i.scrollLeft,a=r.clientTop||i.clientTop||0,n=r.clientLeft||i.clientLeft||0,h=t.top+s-a,c=t.left+o-n;return{top:Math.round(h),left:Math.round(c)}}return function(g,e,u){var l=null,d=null,p=null,f=[100,100],_=[300,300],i=200,r="image/png",s=null;function m(){l.clearRect(0,0,l.canvas.width,l.canvas.height),null!==d&&(l.drawImage(d,0,0,l.canvas.width,l.canvas.height),l.save(),l.fillStyle="rgba(0, 0, 0, 0.65)",l.fillRect(0,0,l.canvas.width,l.canvas.height),l.restore(),p.draw())}function v(){var e,t,i;null!==d?(p.setImage(d),e=[d.width,d.height],t=d.width/d.height,(i=e)[0]>_[0]?(i[0]=_[0],i[1]=i[0]/t):i[0]<f[0]&&(i[0]=f[0],i[1]=i[0]/t),i[1]>_[1]?(i[1]=_[1],i[0]=i[1]*t):i[1]<f[1]&&(i[1]=f[1],i[0]=i[1]*t),g.prop("width",i[0]).prop("height",i[1]).css({"margin-left":-i[0]/2+"px","margin-top":-i[1]/2+"px"}),p.setX(l.canvas.width/2),p.setY(l.canvas.height/2),p.setSize(Math.min(200,l.canvas.width/2,l.canvas.height/2))):g.prop("width",0).prop("height",0).css({"margin-top":0}),m()}function o(e){return angular.isDefined(e.changedTouches)?e.changedTouches:e.originalEvent.changedTouches}function t(e){var t,i,r;null!==d&&(t=I(l.canvas),r="touchmove"===e.type?(i=o(e)[0].pageX,o(e)[0].pageY):(i=e.pageX,e.pageY),p.processMouseMove(i-t.left,r-t.top),m())}function a(e){var t,i,r;e.preventDefault(),e.stopPropagation(),null!==d&&(t=I(l.canvas),r="touchstart"===e.type?(i=o(e)[0].pageX,o(e)[0].pageY):(i=e.pageX,e.pageY),p.processMouseDown(i-t.left,r-t.top),m())}function n(e){var t,i,r;null!==d&&(t=I(l.canvas),r="touchend"===e.type?(i=o(e)[0].pageX,o(e)[0].pageY):(i=e.pageX,e.pageY),p.processMouseUp(i-t.left,r-t.top),m())}this.getResultImageDataURI=function(){var e=angular.element("<canvas></canvas>")[0],t=e.getContext("2d");return e.width=i,e.height=i,null!==d&&t.drawImage(d,(p.getX()-p.getSize()/2)*(d.width/l.canvas.width),(p.getY()-p.getSize()/2)*(d.height/l.canvas.height),p.getSize()*(d.width/l.canvas.width),p.getSize()*(d.height/l.canvas.height),0,0,i,i),null!==s?e.toDataURL(r,s):e.toDataURL(r)},this.setNewImageSource=function(e){var c;d=null,v(),u.trigger("image-updated"),e&&(c=new Image,"http"===e.substring(0,4).toLowerCase()&&(c.crossOrigin="anonymous"),c.onload=function(){z.getData(c,function(){var e=z.getTag(c,"Orientation");if(-1<[3,6,8].indexOf(e)){var t=document.createElement("canvas"),i=t.getContext("2d"),r=c.width,s=c.height,o=0,a=0,n=0;switch(e){case 3:o=-c.width,a=-c.height,n=180;break;case 6:r=c.height,s=c.width,a=-c.height,n=90;break;case 8:r=c.height,s=c.width,o=-c.width,n=270}t.width=r,t.height=s,i.rotate(n*Math.PI/180),i.drawImage(c,o,a);var h=new Image;h.src=t.toDataURL("image/png",.8),h.onload=function(){d=h,setTimeout(function(){u.trigger("load-done"),v(),u.trigger("image-updated")},20)}}else u.trigger("load-done"),d=c;v(),u.trigger("image-updated")})},c.onerror=function(){u.trigger("load-error")},u.trigger("load-start"),c.src=e)},this.setMaxDimensions=function(e,t){var i,r,s,o,a,n,h,c;_=[e,t],null!==d?(i=l.canvas.width,r=l.canvas.height,s=[d.width,d.height],o=d.width/d.height,(a=s)[0]>_[0]?(a[0]=_[0],a[1]=a[0]/o):a[0]<f[0]&&(a[0]=f[0],a[1]=a[0]/o),a[1]>_[1]?(a[1]=_[1],a[0]=a[1]*o):a[1]<f[1]&&(a[1]=f[1],a[0]=a[1]*o),g.prop("width",a[0]).prop("height",a[1]).css({"margin-left":-a[0]/2+"px","margin-top":-a[1]/2+"px"}),n=l.canvas.width/i,h=l.canvas.height/r,c=Math.min(n,h),p.setX(p.getX()*n),p.setY(p.getY()*h),p.setSize(p.getSize()*c)):g.prop("width",0).prop("height",0).css({"margin-top":0}),m()},this.setAreaMinSize=function(e){e=parseInt(e,10),isNaN(e)||(p.setMinSize(e),m())},this.setResultImageSize=function(e){e=parseInt(e,10),isNaN(e)||(i=e)},this.setResultImageFormat=function(e){r=e},this.setResultImageQuality=function(e){e=parseFloat(e),!isNaN(e)&&0<=e&&e<=1&&(s=e)},this.setAreaType=function(e){var t=p.getSize(),i=p.getMinSize(),r=p.getX(),s=p.getY();(p=new("square"===e?S:c)(l,u)).setMinSize(i),p.setSize(t),p.setX(r),p.setY(s),null!==d&&p.setImage(d),m()},l=g[0].getContext("2d"),p=new c(l,u),h.on("mousemove",t),g.on("mousedown",a),h.on("mouseup",n),h.on("touchmove",t),g.on("touchstart",a),h.on("touchend",n),this.destroy=function(){h.off("mousemove",t),g.off("mousedown",a),h.off("mouseup",t),h.off("touchmove",t),g.off("touchstart",a),h.off("touchend",t),g.remove()}}}]),e.factory("cropPubSub",[function(){return function(){var i={};this.on=function(e,t){return e.split(" ").forEach(function(e){i[e]||(i[e]=[]),i[e].push(t)}),this},this.trigger=function(e,t){return angular.forEach(i[e],function(e){e.call(null,t)}),this}}}]),e.directive("imgCrop",["$timeout","cropHost","cropPubSub",function(n,h,t){return{restrict:"E",scope:{image:"=",resultImage:"=",changeOnFly:"=",areaType:"@",areaMinSize:"=",resultImageSize:"=",resultImageFormat:"@",resultImageQuality:"=",onChange:"&",onLoadBegin:"&",onLoadDone:"&",onLoadError:"&"},template:"<canvas></canvas>",controller:["$scope",function(e){e.events=new t}],link:function(i,e){function t(e){var t=a.getResultImageDataURI();s!==t&&(s=t,angular.isDefined(e.resultImage)&&(e.resultImage=t),e.onChange({$dataURI:e.resultImage}))}function r(t){return function(){n(function(){i.$apply(function(e){t(e)})})}}var s,o=i.events,a=new h(e.find("canvas"),{},o);o.on("load-start",r(function(e){e.onLoadBegin({})})).on("load-done",r(function(e){e.onLoadDone({})})).on("load-error",r(function(e){e.onLoadError({})})).on("area-move area-resize",r(function(e){e.changeOnFly&&t(e)})).on("area-move-end area-resize-end image-updated",r(function(e){t(e)})),i.$watch("image",function(){a.setNewImageSource(i.image)}),i.$watch("areaType",function(){a.setAreaType(i.areaType),t(i)}),i.$watch("areaMinSize",function(){a.setAreaMinSize(i.areaMinSize),t(i)}),i.$watch("resultImageSize",function(){a.setResultImageSize(i.resultImageSize),t(i)}),i.$watch("resultImageFormat",function(){a.setResultImageFormat(i.resultImageFormat),t(i)}),i.$watch("resultImageQuality",function(){a.setResultImageQuality(i.resultImageQuality),t(i)}),i.$watch(function(){return[e[0].clientWidth,e[0].clientHeight]},function(e){a.setMaxDimensions(e[0],e[1]),t(i)},!0),i.$on("$destroy",function(){a.destroy()})}}}])}();